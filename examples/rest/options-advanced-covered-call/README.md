# Advanced Covered Call Screener & Analyzer

<div align="center">
  <img src="../../../images/logo.png" alt="Project Logo" width="100%"/>
</div>

An intelligent Python utility that automatically finds the best covered call options across all available expirations with sophisticated profitability analysis. This tool uses real-time market data from Polygon.io to identify optimal covered call opportunities with advanced metrics, smart filtering, and automatic P&L calculation.

## 🚀 Key Features

- **🤖 Fully Automated**: Finds best options across all available expirations automatically
- **🎯 Smart Filtering**: Adapts filters based on symbol type (ETFs vs individual stocks)
- **📊 Auto P&L Calculation**: Automatically fetches closing prices and calculates P&L
- **⚡ Simple Interface**: Just two commands for complete workflow
- **📈 Real-time Data**: Live options chain data from Polygon.io
- **🎲 Probability Analysis**: Black-Scholes probability of profit calculations
- **🧮 Advanced Metrics**: 7 sophisticated profitability metrics for optimal trade selection
- **📋 Multiple Rankings**: Options ranked by 7 different criteria for various strategies

## Disclaimer

**Warning:** The examples, demos, and outputs produced with this project are generated by artificial intelligence and large language models. You acknowledge that this project and any outputs are provided "AS IS", may not always be accurate and may contain material inaccuracies even if they appear accurate because of their level of detail or specificity, outputs may not be error free, accurate, current, complete, or operate as you intended, you should not rely on any outputs or actions without independently confirming their accuracy, and any outputs should not be treated as financial or legal advice. You remain responsible for verifying the accuracy, suitability, and legality of any output before relying on it.

## 📋 Requirements

- Python 3.10+
- `uv` package manager (recommended) or `pip`
- Polygon.io API key (free tier available)

## ⚙️ Setup

1. **Clone the repository**:
   ```bash
   git clone <repository-url>
   cd 0dte_closed
   ```

2. **Install dependencies**:
   ```bash
   # Using uv (recommended)
   uv sync
   
   # Or using pip
   pip install -e .
   ```

3. **Set up environment variables**:
   ```bash
   cp env.example .env
   # Edit .env and add your Polygon API key
   ```

4. **Get a Polygon.io API key**:
   - Visit [polygon.io](https://polygon.io/)
   - Sign up for a free account
   - Copy your API key to the `.env` file

## 🎯 Usage

### Find Best Options (Main Command)

Automatically find the best covered call options with multiple ranking criteria:

```bash
# Find best SPY options (saves 1 CSV with profitable ranking by default)
uv run screener.py find --symbol SPY

# Use different ranking criteria
uv run screener.py find --symbol SPY --criteria premium

# Find best NVDA options with longer search window
uv run screener.py find --symbol NVDA --max-days 30

# Find best TSLA options, show top 3 per criteria
uv run screener.py find --symbol TSLA --max-options 3
```

**Output Example:**
```
🔍 Scanning SPY for available expirations...
📅 Found 6 available expirations: ['2025-09-16', '2025-09-17', '2025-09-18', '2025-09-19', '2025-09-22', '2025-09-23']
💰 Current spot price: $660.30
🎯 Using filters: {'min_otm_pct': 0.0, 'max_otm_pct': 0.02, 'delta_lo': 0.15, 'delta_hi': 0.3, 'min_bid': 0.05, 'min_oi': 100, 'max_spread_to_mid': 0.5}
📊 Checking expiration: 2025-09-16
  ✅ Found 1 candidates
📊 Checking expiration: 2025-09-17
  ✅ Found 2 candidates
...

🏆 Found 18 total candidates. Top options by different criteria:

📊 Top 5 by Premium:
   ========================================================================================================================
   Exp        Strike   Premium  Yield%  Delta  PoP%   Max$     Score   
   ------------------------------------------------------------------------------------------------------------------------
   09-23      $666     $1.505   0.23  % 0.277 56.6 % $7.20    0.0023 
   09-19      $665     $1.295   0.20  % 0.277 56.8 % $5.99    0.0020 
   09-22      $666     $1.270   0.19  % 0.258 56.0 % $6.97    0.0019 

📊 Top 5 by Probability:
   ========================================================================================================================
   Exp        Strike   Premium  Yield%  Delta  PoP%   Max$     Score   
   ------------------------------------------------------------------------------------------------------------------------
   09-16      $661     $0.185   0.03  % 0.272 61.8 % $0.88    0.6179 
   09-19      $665     $1.295   0.20  % 0.277 56.8 % $5.99    0.5680 

📊 Top 5 by Balanced:
   ========================================================================================================================
   Exp        Strike   Premium  Yield%  Delta  PoP%   Max$     Score   
   ------------------------------------------------------------------------------------------------------------------------
   09-23      $666     $1.505   0.23  % 0.277 56.6 % $7.20    0.0013 
   09-19      $665     $1.295   0.20  % 0.277 56.8 % $5.99    0.0011 

📊 Top 5 by Max Profit:
   ========================================================================================================================
   Exp        Strike   Premium  Yield%  Delta  PoP%   Max$     Score   
   ------------------------------------------------------------------------------------------------------------------------
   09-23      $669     $0.825   0.12  % 0.174 53.6 % $9.52    0.0144 
   09-22      $669     $0.655   0.10  % 0.154 53.0 % $9.35    0.0142 

💾 Saved CSV file: data/spy_profitable_options.csv
   📊 Criteria: Profitable
   📈 Options: 3 options

🎯 Top Recommendation: Sell the 2025-09-22 $665 call for $1.540
   Premium Yield: 0.23% | PoP: 57.3% | Delta: 0.296

💡 Next step: Run 'python screener.py pnl --csv data/spy_profitable_options.csv' after expiration

📋 Other ranking criteria available:
   • Premium: Highest income potential
   • Probability: Safest options (least likely to be assigned)
   • Balanced: Best risk/reward combination
   • Max Profit: Highest total profit potential
   • Expected Value: Best mathematical edge (most profitable long-term)
   • Profitable: Advanced risk-adjusted scoring (current selection)
   • Aggressive: High premium + capital efficiency

💡 To use a different criteria, run: python screener.py find --criteria [criteria_name]

**CSV Output:** The tool saves one CSV file per run based on your selected criteria, containing all the top options with advanced metrics. Each file includes:
- All basic metrics (premium, delta, PoP, etc.)
- Advanced profitability metrics (Expected Value, Risk-Adjusted Return, Theta, etc.)
- Scoring data for further analysis
```

### Calculate P&L (After Expiration)

Automatically calculate P&L by fetching closing prices:

```bash
# Calculate P&L for your trades
uv run screener.py pnl --csv data/spy_2025-09-22_best_call.csv
```

**Output Example:**
```
🔄 Calculating P&L for 1 trades...
  ✅ 2025-09-22: Strike $665, Close $662.45, P&L: $151.00

📊 P&L Summary:
   Valid Trades: 1
   Total P&L: $151.00
   Win Rate: 100.0%
   Avg P&L per Trade: $151.00

💾 P&L results saved to: data/spy_2025-09-22_best_call_pnl.csv
```

## 🎛️ Command Options

### Find Command

| Option | Default | Description |
|--------|---------|-------------|
| `--symbol` | SPY | Symbol to screen (SPY, NVDA, TSLA, etc.) |
| `--max-days` | 7 | Maximum days ahead to search for expirations |
| `--max-options` | 5 | Maximum number of options to show per criteria |
| `--criteria` | profitable | Ranking criteria (premium, probability, balanced, max_profit, expected_value, profitable, aggressive) |
| `--outdir` | ./data | Output directory for CSV files |

### P&L Command

| Option | Required | Description |
|--------|----------|-------------|
| `--csv` | Yes | Path to CSV file from find command |
| `--outdir` | ./data | Output directory for P&L results |

## 📊 Ranking Criteria

The tool provides multiple ranking criteria to help you choose based on your risk preference:

### **Premium Yield**
- **Best for:** Income-focused strategies
- **Shows:** Options with highest premium as % of stock price
- **Risk:** Higher premium usually means higher assignment risk

### **Probability** 
- **Best for:** Conservative strategies
- **Shows:** Options with highest probability of profit (least likely to be assigned)
- **Risk:** Lower premium but safer

### **Balanced**
- **Best for:** Most users (recommended)
- **Shows:** Best combination of premium yield × probability of profit
- **Risk:** Good balance of income and safety

### **Max Profit**
- **Best for:** Aggressive strategies
- **Shows:** Options with highest total profit potential
- **Risk:** Higher strike prices, more assignment risk

## 🧠 Smart Filtering

The tool automatically adapts filters based on symbol characteristics:

### ETFs (SPY, QQQ, IWM)
- Stricter filters for safety
- Higher liquidity requirements
- Tighter spreads allowed

### Tech Stocks (NVDA, TSLA, AAPL, MSFT, AMZN, GOOGL, META)
- Relaxed filters for higher volatility
- Lower open interest requirements
- Wider spreads allowed

### High-Priced Stocks (>$200)
- Adjusted for wider spreads
- Higher minimum bid requirements

### General Stocks
- Moderate filters for balance

## 🧮 Advanced Profitability Metrics

The tool calculates 7 sophisticated metrics to maximize profitability:

### **1. Expected Value (EV) - Most Critical**
- **What it measures:** Mathematical edge of each trade
- **Formula:** `EV = (Win Probability × Win Amount) + (Loss Probability × Loss Amount)`
- **Why it matters:** Shows the true profitability potential over many trades

### **2. Risk-Adjusted Return (Sharpe-like)**
- **What it measures:** Return per unit of risk taken
- **Formula:** `Risk-Adjusted Return = Expected Value / (Risk × Spot Price)`
- **Why it matters:** Identifies trades with best risk/reward ratios

### **3. Time Decay (Theta) Analysis**
- **What it measures:** Daily premium decay rate
- **Formula:** `Daily Theta = Premium / Days to Expiry`
- **Why it matters:** Shows how much premium you collect per day

### **4. Liquidity Score**
- **What it measures:** Execution quality (volume vs spread)
- **Formula:** `Liquidity = (Open Interest × 1000) / (Spread / Bid)`
- **Why it matters:** Better liquidity = better fills, less slippage

### **5. Volatility-Adjusted Premium**
- **What it measures:** Premium relative to market volatility
- **Formula:** `Vol-Adjusted Premium = Premium / (IV × √Time)`
- **Why it matters:** Identifies when options are relatively cheap/expensive

### **6. Capital Efficiency**
- **What it measures:** Return per dollar of capital at risk
- **Formula:** `Capital Efficiency = Premium / Capital at Risk`
- **Why it matters:** Maximizes returns on capital deployed

### **7. Premium-to-Risk Ratio**
- **What it measures:** Premium collected vs maximum potential loss
- **Formula:** `Premium-to-Risk = Premium / Max Loss`
- **Why it matters:** Shows downside protection level

## 📊 Output Files

### Find Command Output
Creates CSV files with columns:

**Basic Metrics:**
- `ticker`: Option contract identifier
- `expiration`: Expiration date
- `strike`: Strike price
- `delta`: Option delta
- `bid`/`ask`/`mid`: Bid, ask, and midpoint prices
- `open_interest`: Number of open contracts
- `iv`: Implied volatility
- `spot`: Current underlying price
- `premium_yield`: Premium as percentage of spot price
- `breakeven`: Breakeven price for the strategy
- `max_profit`: Maximum profit potential
- `pop_est`: Estimated probability of profit

**Advanced Profitability Metrics:**
- `expected_value`: Mathematical expected value of the trade
- `expected_value_pct`: Expected value as percentage of spot price
- `daily_theta`: Daily time decay rate
- `theta_efficiency`: Theta per dollar invested
- `liquidity_score`: Execution quality score
- `vol_adjusted_premium`: Premium adjusted for volatility
- `capital_efficiency`: Return per dollar of capital at risk
- `risk_adjusted_return`: Sharpe-like risk-adjusted return
- `premium_to_risk`: Premium vs maximum potential loss ratio

**Scoring Data:**
- `score_premium`: Premium-based score
- `score_pop`: Probability-based score
- `score_balanced`: Balanced risk/reward score
- `score_expected_value`: Expected value score
- `score_profitable`: Advanced profitability score
- `score_aggressive`: Aggressive strategy score

### P&L Command Output
Adds P&L columns:
- `close_price`: Closing price on expiration date
- `assigned`: Whether option was assigned
- `pnl_per_share`: P&L per share
- `pnl_per_contract`: P&L per contract (100 shares)

## 🔄 Complete Workflow

1. **Find Best Option**:
   ```bash
   uv run screener.py find --symbol SPY
   ```

2. **Wait for Expiration** (options expire on their expiration date)

3. **Calculate P&L**:
   ```bash
   uv run screener.py pnl --csv data/spy_2025-09-22_best_call.csv
   ```

4. **Repeat** for different symbols or dates

## 🎯 Strategy Examples

### Conservative Strategy (Profitable Ranking)
```bash
# SPY with profitable ranking (default)
uv run screener.py find --symbol SPY
```
- Advanced risk-adjusted scoring
- Best long-term profitability
- Recommended for most users

### Aggressive Strategy (Premium Ranking)
```bash
# NVDA for higher premiums
uv run screener.py find --symbol NVDA --criteria premium --max-days 30
```
- Highest income potential
- Higher premium yield (1-2% vs 0.2-0.3%)
- Better returns but higher risk

### Diversified Approach
```bash
# Multiple symbols
uv run screener.py find --symbol SPY
uv run screener.py find --symbol QQQ
uv run screener.py find --symbol NVDA
```

## 🚨 Troubleshooting

### Common Issues

- **"No options found"**
  - Market may be closed or it's a holiday
  - Try different symbol (SPY, QQQ, NVDA, TSLA)
  - Increase `--max-days` parameter

- **"Could not resolve spot price"**
  - Check if market is open
  - Verify symbol exists and is actively traded

- **"Could not get closing price"**
  - Option hasn't expired yet (future date)
  - Market data not available for that date

### Performance Tips

- Default `--max-days 7` provides good balance of speed and options
- Use `--max-options 3` for faster output if you only need a few choices
- Default `--criteria profitable` provides best risk-adjusted results
- Use `--criteria premium` for highest income potential
- Focus on liquid symbols (SPY, QQQ, NVDA, TSLA)
- Run during market hours for best results

## 📈 Backtesting

The tool is perfect for systematic backtesting:

1. **Collect Data**: Run `find` command daily for different symbols
2. **Wait for Expiration**: Let options expire naturally
3. **Calculate P&L**: Run `pnl` command on all CSV files
4. **Analyze Results**: Review P&L summaries and win rates

## 🔧 Environment Variables

- `POLYGON_API_KEY` (required): Your Polygon.io API key

## 📄 License

MIT — see `LICENSE`.

---

**Note**: This tool is for educational and research purposes. Always do your own research before making investment decisions. Options trading involves significant risk and may not be suitable for all investors.